<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>传颂 - 性能监控面板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #7c4dff;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #7c4dff;
            padding-bottom: 5px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .metric.good { background: #d4edda; }
        .metric.warning { background: #fff3cd; }
        .metric.error { background: #f8d7da; }
        
        .buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            background: #7c4dff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }
        
        button:hover {
            background: #5e35b1;
        }
        
        .logs {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-good { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>传颂 - 性能监控面板</h1>
        
        <div class="buttons">
            <button onclick="testMainSite()">测试主站</button>
            <button onclick="runDiagnostics()">运行诊断</button>
            <button onclick="clearLogs()">清除日志</button>
            <button onclick="exportReport()">导出报告</button>
        </div>
        
        <div class="cards">
            <div class="card">
                <h2>系统状态</h2>
                <div id="system-status">
                    <div class="metric">
                        <span>浏览器支持</span>
                        <span id="browser-support">检测中...</span>
                    </div>
                    <div class="metric">
                        <span>网络状态</span>
                        <span id="network-status">检测中...</span>
                    </div>
                    <div class="metric">
                        <span>协议类型</span>
                        <span id="protocol-type">检测中...</span>
                    </div>
                    <div class="metric">
                        <span>CORS 支持</span>
                        <span id="cors-support">检测中...</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>性能指标</h2>
                <div id="performance-metrics">
                    <div class="metric">
                        <span>页面加载时间</span>
                        <span id="load-time">-- ms</span>
                    </div>
                    <div class="metric">
                        <span>DOMContentLoaded</span>
                        <span id="dom-ready">-- ms</span>
                    </div>
                    <div class="metric">
                        <span>首次绘制</span>
                        <span id="first-paint">-- ms</span>
                    </div>
                    <div class="metric">
                        <span>首次内容绘制</span>
                        <span id="first-contentful-paint">-- ms</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>资源状态</h2>
                <div id="resource-status">
                    <div class="metric">
                        <span>CSS 文件</span>
                        <span id="css-status">检测中...</span>
                    </div>
                    <div class="metric">
                        <span>JavaScript 文件</span>
                        <span id="js-status">检测中...</span>
                    </div>
                    <div class="metric">
                        <span>图片资源</span>
                        <span id="image-status">检测中...</span>
                    </div>
                    <div class="metric">
                        <span>字体文件</span>
                        <span id="font-status">检测中...</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>错误监控</h2>
                <div id="error-monitoring">
                    <div class="metric">
                        <span>JavaScript 错误</span>
                        <span id="js-errors">0</span>
                    </div>
                    <div class="metric">
                        <span>CORS 错误</span>
                        <span id="cors-errors">0</span>
                    </div>
                    <div class="metric">
                        <span>资源加载错误</span>
                        <span id="resource-errors">0</span>
                    </div>
                    <div class="metric">
                        <span>网络错误</span>
                        <span id="network-errors">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>实时日志</h2>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script>
        // 性能监控系统
        class PerformanceMonitor {
            constructor() {
                this.errors = {
                    js: 0,
                    cors: 0,
                    resource: 0,
                    network: 0
                };
                this.init();
            }
            
            init() {
                this.setupErrorListeners();
                this.checkSystemStatus();
                this.measurePerformance();
                this.checkResources();
                this.startRealTimeMonitoring();
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logs = document.getElementById('logs');
                const color = type === 'error' ? '#ff6b6b' : type === 'warning' ? '#feca57' : '#48dbfb';
                logs.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
                logs.scrollTop = logs.scrollHeight;
                console.log(`[Performance Monitor] ${message}`);
            }
            
            setupErrorListeners() {
                window.addEventListener('error', (e) => {
                    this.errors.js++;
                    document.getElementById('js-errors').textContent = this.errors.js;
                    
                    if (e.message.includes('CORS')) {
                        this.errors.cors++;
                        document.getElementById('cors-errors').textContent = this.errors.cors;
                        this.log(`CORS 错误: ${e.message}`, 'error');
                    } else if (e.filename) {
                        this.errors.resource++;
                        document.getElementById('resource-errors').textContent = this.errors.resource;
                        this.log(`资源加载错误: ${e.filename}`, 'error');
                    } else {
                        this.log(`JavaScript 错误: ${e.message}`, 'error');
                    }
                });
                
                window.addEventListener('unhandledrejection', (e) => {
                    this.errors.network++;
                    document.getElementById('network-errors').textContent = this.errors.network;
                    this.log(`未处理的 Promise 拒绝: ${e.reason}`, 'error');
                });
            }
            
            checkSystemStatus() {
                // 浏览器支持检测
                const browserSupport = this.checkBrowserSupport();
                document.getElementById('browser-support').innerHTML = 
                    `<span class="status-indicator status-${browserSupport.status}"></span>${browserSupport.text}`;
                
                // 网络状态
                const networkStatus = navigator.onLine ? 'online' : 'offline';
                document.getElementById('network-status').innerHTML = 
                    `<span class="status-indicator status-${networkStatus === 'online' ? 'good' : 'error'}"></span>${networkStatus === 'online' ? '在线' : '离线'}`;
                
                // 协议类型
                const protocol = window.location.protocol;
                const protocolStatus = protocol === 'file:' ? 'warning' : 'good';
                document.getElementById('protocol-type').innerHTML = 
                    `<span class="status-indicator status-${protocolStatus}"></span>${protocol}`;
                
                // CORS 支持
                const corsSupport = protocol !== 'file:' ? 'good' : 'error';
                document.getElementById('cors-support').innerHTML = 
                    `<span class="status-indicator status-${corsSupport}"></span>${corsSupport === 'good' ? '支持' : '受限'}`;
                
                this.log(`系统状态检查完成 - 协议: ${protocol}, 网络: ${networkStatus}`);
            }
            
            checkBrowserSupport() {
                const features = {
                    'fetch': 'fetch' in window,
                    'Promise': 'Promise' in window,
                    'ES6': () => {
                        try {
                            new Function('() => {}');
                            return true;
                        } catch (e) {
                            return false;
                        }
                    }
                };
                
                const support = Object.values(features).every(f => typeof f === 'function' ? f() : f);
                return {
                    status: support ? 'good' : 'warning',
                    text: support ? '完全支持' : '部分支持'
                };
            }
            
            measurePerformance() {
                if (!('performance' in window)) {
                    this.log('Performance API 不可用', 'warning');
                    return;
                }
                
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const timing = performance.timing;
                        const loadTime = timing.loadEventEnd - timing.navigationStart;
                        const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;
                        
                        document.getElementById('load-time').textContent = loadTime + ' ms';
                        document.getElementById('dom-ready').textContent = domReady + ' ms';
                        
                        // 获取绘制指标
                        if ('getEntriesByType' in performance) {
                            const paintEntries = performance.getEntriesByType('paint');
                            paintEntries.forEach(entry => {
                                if (entry.name === 'first-paint') {
                                    document.getElementById('first-paint').textContent = Math.round(entry.startTime) + ' ms';
                                } else if (entry.name === 'first-contentful-paint') {
                                    document.getElementById('first-contentful-paint').textContent = Math.round(entry.startTime) + ' ms';
                                }
                            });
                        }
                        
                        this.log(`性能测量完成 - 加载时间: ${loadTime}ms, DOM就绪: ${domReady}ms`);
                    }, 100);
                });
            }
            
            async checkResources() {
                const resources = [
                    { type: 'css', files: ['css/bootstrap.css', 'css/fonts.css', 'css/style.css'] },
                    { type: 'js', files: ['js/core.min.js', 'js/script.js', 'js/compatibility-fix.js'] },
                    { type: 'image', files: ['images/favicon.ico'] },
                    { type: 'font', files: ['fonts/fl-bigmug-line.woff'] }
                ];
                
                for (const resource of resources) {
                    let successCount = 0;
                    
                    for (const file of resource.files) {
                        try {
                            const response = await fetch(file, { method: 'HEAD' });
                            if (response.ok) successCount++;
                        } catch (e) {
                            // 文件协议下可能会失败，这是正常的
                        }
                    }
                    
                    const status = successCount === resource.files.length ? 'good' : 
                                  successCount > 0 ? 'warning' : 'error';
                    const statusText = `${successCount}/${resource.files.length} 可用`;
                    
                    document.getElementById(`${resource.type}-status`).innerHTML = 
                        `<span class="status-indicator status-${status}"></span>${statusText}`;
                }
                
                this.log('资源状态检查完成');
            }
            
            startRealTimeMonitoring() {
                setInterval(() => {
                    this.updateNetworkStatus();
                    this.updateMemoryUsage();
                }, 5000);
            }
            
            updateNetworkStatus() {
                const isOnline = navigator.onLine;
                const element = document.getElementById('network-status');
                element.innerHTML = `<span class="status-indicator status-${isOnline ? 'good' : 'error'}"></span>${isOnline ? '在线' : '离线'}`;
            }
            
            updateMemoryUsage() {
                if ('memory' in performance) {
                    const memory = performance.memory;
                    const used = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                    this.log(`内存使用: ${used}MB`);
                }
            }
        }
        
        // 全局函数
        function testMainSite() {
            monitor.log('开始测试主站...', 'info');
            window.open('index.html', '_blank');
        }
        
        function runDiagnostics() {
            monitor.log('运行完整诊断...', 'info');
            monitor.checkSystemStatus();
            monitor.checkResources();
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                errors: monitor.errors,
                performance: {
                    loadTime: document.getElementById('load-time').textContent,
                    domReady: document.getElementById('dom-ready').textContent
                },
                browser: navigator.userAgent,
                protocol: window.location.protocol
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance-report-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            monitor.log('性能报告已导出');
        }
        
        // 初始化监控系统
        const monitor = new PerformanceMonitor();
    </script>
</body>
</html>
